<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menara Pertahanan (Tower Defense)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            touch-action: none; 
        }
        
        .pixel-font {
            font-family: 'Press Start 2P', cursive;
        }

        /* Animasi kustom */
        @keyframes pulse-red {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
        }
        
        .animate-pulse-red {
            animation: pulse-red 2s infinite;
        }

        canvas {
            image-rendering: pixelated; 
            cursor: crosshair;
        }

        /* Custom Scrollbar for Map Selection */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="bg-gray-900 text-white h-screen overflow-hidden relative">

    <!-- 1. HOME SCREEN -->
    <div id="homeScreen" class="absolute inset-0 z-50 bg-gray-900 flex flex-col items-center justify-center space-y-8 p-4">
        <div class="text-center space-y-4">
            <h1 class="text-4xl md:text-6xl text-yellow-400 pixel-font leading-relaxed tracking-wider drop-shadow-lg">
                MENARA<br>PERTAHANAN
            </h1>
            <p class="text-gray-400 text-lg md:text-xl tracking-widest uppercase">Lindungi Benteng Terakhir</p>
        </div>
        
        <button onclick="showMapSelection()" class="group relative px-8 py-4 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg text-xl shadow-[0_4px_0_rgb(30,58,138)] active:shadow-[0_0px_0_rgb(30,58,138)] active:translate-y-1 transition-all">
            <span class="relative z-10 flex items-center gap-3">
                MULAI PERMAINAN
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
                </svg>
            </span>
        </button>

        <div class="absolute bottom-8 text-gray-600 text-sm">
            Dibuat dengan HTML Canvas & Tailwind
        </div>
    </div>

    <!-- 2. MAP SELECTION SCREEN -->
    <div id="mapSelectScreen" class="hidden absolute inset-0 z-50 bg-gray-900/95 flex flex-col items-center justify-center p-4 backdrop-blur-sm">
        <h2 class="text-3xl font-bold text-white mb-8 pixel-font text-center">PILIH MEDAN PERANG</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 w-full max-w-6xl px-4 overflow-y-auto max-h-[80vh] hide-scrollbar pb-20">
            <!-- Map Card 1 -->
            <div class="bg-gray-800 rounded-xl p-4 border-4 border-gray-700 hover:border-blue-500 transition-colors cursor-pointer group flex flex-col" onclick="loadMap(0)">
                <div class="bg-gray-900 h-40 rounded mb-4 flex items-center justify-center overflow-hidden relative">
                     <!-- Simple CSS Minimap Representation -->
                     <div class="absolute inset-0 opacity-50 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDQwIDQwIiBmaWxsPSJub25lIiBzdHJva2U9IiMzNzQxNTEiIHN0cm9rZS13aWR0aD0iMSI+PHBhdGggZD0iTTAgMGg0MHY0MEgwWiIvPjwvc3ZnPg==')]"></div>
                     <div class="w-full h-2 bg-blue-500 rotate-12 transform scale-150"></div>
                </div>
                <h3 class="text-xl font-bold text-white mb-2">Lembah Zig-Zag</h3>
                <p class="text-sm text-gray-400 mb-4 flex-grow">Medan berliku standar. Cocok untuk pemula belajar strategi dasar.</p>
                <div class="flex justify-between items-center mt-auto">
                    <span class="text-xs font-bold text-green-400 bg-green-400/10 px-2 py-1 rounded">MUDAH</span>
                    <button class="bg-blue-600 px-4 py-2 rounded font-bold text-sm group-hover:bg-blue-500">PILIH</button>
                </div>
            </div>

            <!-- Map Card 2 -->
            <div class="bg-gray-800 rounded-xl p-4 border-4 border-gray-700 hover:border-red-500 transition-colors cursor-pointer group flex flex-col" onclick="loadMap(1)">
                <div class="bg-gray-900 h-40 rounded mb-4 flex items-center justify-center overflow-hidden relative">
                     <div class="absolute inset-0 opacity-50 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDQwIDQwIiBmaWxsPSJub25lIiBzdHJva2U9IiMzNzQxNTEiIHN0cm9rZS13aWR0aD0iMSI+PHBhdGggZD0iTTAgMGg0MHY0MEgwWiIvPjwvc3ZnPg==')]"></div>
                     <div class="border-4 border-red-500 w-24 h-24 rounded-full"></div>
                </div>
                <h3 class="text-xl font-bold text-white mb-2">Labirin Melingkar</h3>
                <p class="text-sm text-gray-400 mb-4 flex-grow">Jalur memutar yang panjang. Musuh akan mengelilingi markas sebelum menyerang.</p>
                <div class="flex justify-between items-center mt-auto">
                    <span class="text-xs font-bold text-yellow-400 bg-yellow-400/10 px-2 py-1 rounded">SEDANG</span>
                    <button class="bg-blue-600 px-4 py-2 rounded font-bold text-sm group-hover:bg-blue-500">PILIH</button>
                </div>
            </div>

             <!-- Map Card 3 -->
             <div class="bg-gray-800 rounded-xl p-4 border-4 border-gray-700 hover:border-purple-500 transition-colors cursor-pointer group flex flex-col" onclick="loadMap(2)">
                <div class="bg-gray-900 h-40 rounded mb-4 flex items-center justify-center overflow-hidden relative">
                     <div class="absolute inset-0 opacity-50 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDQwIDQwIiBmaWxsPSJub25lIiBzdHJva2U9IiMzNzQxNTEiIHN0cm9rZS13aWR0aD0iMSI+PHBhdGggZD0iTTAgMGg0MHY0MEgwWiIvPjwvc3ZnPg==')]"></div>
                     <div class="flex gap-2">
                        <div class="w-2 h-24 bg-purple-500"></div>
                        <div class="w-2 h-24 bg-purple-500"></div>
                        <div class="w-2 h-24 bg-purple-500"></div>
                     </div>
                </div>
                <h3 class="text-xl font-bold text-white mb-2">Jalur Ganda</h3>
                <p class="text-sm text-gray-400 mb-4 flex-grow">Jalur yang sangat panjang dan sempit. Membutuhkan penempatan Sniper yang presisi.</p>
                <div class="flex justify-between items-center mt-auto">
                    <span class="text-xs font-bold text-red-400 bg-red-400/10 px-2 py-1 rounded">SULIT</span>
                    <button class="bg-blue-600 px-4 py-2 rounded font-bold text-sm group-hover:bg-blue-500">PILIH</button>
                </div>
            </div>
        </div>

        <button onclick="showHome()" class="mt-8 text-gray-400 hover:text-white underline">Kembali ke Menu Utama</button>
    </div>

    <!-- 3. GAME SCREEN (Hidden by default) -->
    <div id="gameUI" class="hidden h-screen flex flex-col items-center justify-center w-full">
        <!-- UI Header -->
        <div class="w-full max-w-4xl p-4 flex justify-between items-center bg-gray-800 rounded-b-xl shadow-lg border-b-4 border-gray-700 z-10 shrink-0">
            <button onclick="quitGame()" class="mr-4 text-gray-400 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
            </button>
            <div class="flex gap-4 md:gap-6 flex-grow">
                <div class="flex flex-col">
                    <span class="text-[10px] md:text-xs text-gray-400 uppercase tracking-widest">Nyawa</span>
                    <span id="livesDisplay" class="text-xl md:text-2xl font-bold text-red-500">20</span>
                </div>
                <div class="flex flex-col">
                    <span class="text-[10px] md:text-xs text-gray-400 uppercase tracking-widest">Uang</span>
                    <span id="moneyDisplay" class="text-xl md:text-2xl font-bold text-yellow-400">Rp 100</span>
                </div>
                <div class="flex flex-col">
                    <span class="text-[10px] md:text-xs text-gray-400 uppercase tracking-widest">Gelombang</span>
                    <span id="waveDisplay" class="text-xl md:text-2xl font-bold text-blue-400">1</span>
                </div>
            </div>
            
            <button id="startWaveBtn" class="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 md:px-6 rounded text-sm md:text-base shadow-[0_4px_0_rgb(21,128,61)] active:shadow-[0_0px_0_rgb(21,128,61)] active:translate-y-1 transition-all">
                MULAI WAVE
            </button>
        </div>

        <!-- Game Container -->
        <div class="relative mt-2 md:mt-4 shadow-2xl rounded-lg overflow-hidden border-4 border-gray-700 bg-gray-900 shrink-0">
            <canvas id="gameCanvas" width="800" height="600" class="max-w-full h-auto max-h-[60vh] md:max-h-[70vh] block"></canvas>
            
            <!-- Game Over Screen -->
            <div id="gameOverScreen" class="hidden absolute inset-0 bg-black/80 flex flex-col items-center justify-center z-50">
                <h2 class="text-3xl md:text-5xl font-bold text-red-500 mb-4 pixel-font text-center leading-tight">GAME OVER</h2>
                <p class="text-xl text-gray-300 mb-8">Markas hancur!</p>
                <div class="flex gap-4">
                    <button onclick="quitGame()" class="bg-gray-600 text-white font-bold py-3 px-6 rounded hover:bg-gray-500 transition">MENU UTAMA</button>
                    <button onclick="restartLevel()" class="bg-white text-black font-bold py-3 px-8 rounded hover:bg-gray-200 transition">MAIN LAGI</button>
                </div>
            </div>
        </div>

        <!-- Tower Selection Footer -->
        <div class="w-full max-w-4xl mt-2 md:mt-4 p-2 bg-gray-800 rounded-t-xl border-t-4 border-gray-700 flex justify-center gap-2 md:gap-4 overflow-x-auto shrink-0 pb-6 md:pb-2">
            
            <button onclick="selectTower('archer')" id="btn-archer" class="tower-btn relative group flex flex-col items-center bg-gray-700 p-2 rounded border-2 border-gray-600 hover:bg-gray-600 hover:border-blue-400 w-20 md:w-24 flex-shrink-0 transition-all">
                <div class="w-6 h-6 md:w-8 md:h-8 rounded-full bg-blue-500 border-2 border-white mb-1 shadow-lg group-hover:scale-110 transition-transform"></div>
                <span class="text-[10px] md:text-xs font-bold">Pemanah</span>
                <span class="text-[10px] md:text-xs text-yellow-400 font-mono">Rp 50</span>
            </button>

            <button onclick="selectTower('cannon')" id="btn-cannon" class="tower-btn relative group flex flex-col items-center bg-gray-700 p-2 rounded border-2 border-gray-600 hover:bg-gray-600 hover:border-red-400 w-20 md:w-24 flex-shrink-0 transition-all">
                <div class="w-6 h-6 md:w-8 md:h-8 rounded bg-red-600 border-2 border-white mb-1 shadow-lg group-hover:scale-110 transition-transform"></div>
                <span class="text-[10px] md:text-xs font-bold">Meriam</span>
                <span class="text-[10px] md:text-xs text-yellow-400 font-mono">Rp 120</span>
            </button>

            <button onclick="selectTower('sniper')" id="btn-sniper" class="tower-btn relative group flex flex-col items-center bg-gray-700 p-2 rounded border-2 border-gray-600 hover:bg-gray-600 hover:border-purple-400 w-20 md:w-24 flex-shrink-0 transition-all">
                <div class="w-6 h-6 md:w-8 md:h-8 rounded-full bg-purple-600 border-4 border-gray-900 mb-1 shadow-lg group-hover:scale-110 transition-transform relative">
                    <div class="absolute inset-0 border border-white rounded-full opacity-50"></div>
                </div>
                <span class="text-[10px] md:text-xs font-bold">Sniper</span>
                <span class="text-[10px] md:text-xs text-yellow-400 font-mono">Rp 200</span>
            </button>

        </div>
    </div>

    <script>
        // --- DATA PETA (MAPS) ---
        const TILE_SIZE = 40;
        
        const MAP_DATA = [
            // PETA 1: Zig-Zag (Lembah Zig-Zag)
            {
                name: "Lembah Zig-Zag",
                grid: [
                    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                    [1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                    [0,0,0,1,0,0,0,1,1,1,1,1,1,1,0,0,0,0,0,0],
                    [0,0,0,1,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,0],
                    [0,0,0,1,1,1,1,1,0,0,0,0,0,1,1,1,1,0,0,0],
                    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0],
                    [0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,0,0],
                    [0,1,1,1,1,1,1,0,0,0,1,0,0,0,0,0,0,0,0,0],
                    [0,1,0,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0,0,0],
                    [0,1,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0,0],
                    [0,1,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,0],
                    [0,1,1,1,1,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0],
                    [0,0,0,0,1,0,0,0,0,0,0,0,0,1,0,0,0,1,1,1],
                    [0,0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
                ],
                waypoints: [
                    {x: 0, y: 1}, {x: 3, y: 1}, {x: 3, y: 4}, {x: 7, y: 4}, {x: 7, y: 2}, 
                    {x: 13, y: 2}, {x: 13, y: 4}, {x: 16, y: 4}, {x: 16, y: 6}, {x: 10, y: 6},
                    {x: 10, y: 9}, {x: 6, y: 9}, {x: 6, y: 7}, {x: 1, y: 7}, {x: 1, y: 11},
                    {x: 4, y: 11}, {x: 4, y: 13}, {x: 13, y: 13}, {x: 13, y: 10}, {x: 17, y: 10},
                    {x: 17, y: 12}, {x: 19, y: 12}
                ]
            },
            // PETA 2: Melingkar (Labirin Melingkar)
            {
                name: "Labirin Melingkar",
                grid: [
                    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
                    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
                    [1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1],
                    [1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1],
                    [1,0,1,0,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1],
                    [1,0,1,0,1,0,0,0,0,0,0,0,0,0,0,1,0,1,0,1],
                    [1,0,1,0,1,0,1,1,1,1,1,1,1,1,0,1,0,1,0,1],
                    [1,0,1,0,1,0,1,0,0,0,0,0,0,1,0,1,0,1,0,1],
                    [1,0,1,0,1,0,1,0,1,1,1,1,0,1,0,1,0,1,0,1],
                    [1,0,1,0,1,0,1,0,1,0,0,0,0,1,0,1,0,1,0,1],
                    [1,0,1,0,1,0,1,1,1,0,0,0,0,1,0,1,0,1,0,1],
                    [1,0,1,0,1,0,0,0,0,0,0,0,0,1,0,1,0,1,0,1],
                    [1,0,1,0,1,1,1,1,1,1,1,1,1,1,0,1,0,1,0,1],
                    [1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1],
                    [1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
                ],
                waypoints: [
                    {x:0,y:0}, {x:19,y:0}, {x:19,y:14}, {x:2,y:14}, {x:2,y:2}, {x:17,y:2},
                    {x:17,y:12}, {x:4,y:12}, {x:4,y:4}, {x:15,y:4}, {x:15,y:10}, {x:6,y:10},
                    {x:6,y:6}, {x:13,y:6}, {x:13,y:8}, {x:8,y:8} // End inside
                ]
            },
            // PETA 3: Tantangan (Jalur Ganda - Long)
            {
                name: "Jalur Ganda",
                grid: [
                    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1],
                    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],
                    [1,1,1,1,1,1,1,1,1,1,0,0,1,1,1,1,1,1,1,0],
                    [0,0,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,0],
                    [0,1,1,1,1,1,1,1,1,1,0,0,1,1,1,1,1,1,1,0],
                    [0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],
                    [0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],
                    [0,1,1,1,1,1,1,1,1,1,0,0,1,1,1,1,1,1,1,0],
                    [0,0,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,0],
                    [1,1,1,1,1,1,1,1,1,1,0,0,1,1,1,1,1,1,1,1],
                    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1] 
                ],
                waypoints: [
                    {x:0,y:0}, {x:0,y:2}, {x:9,y:2}, {x:9,y:5}, {x:1,y:5}, {x:1,y:8}, {x:9,y:8}, 
                    {x:9,y:11}, {x:0,y:11}, {x:0,y:14}, {x:19,y:14}, {x:19,y:11}, {x:12,y:11}, 
                    {x:12,y:8}, {x:18,y:8}, {x:18,y:5}, {x:12,y:5}, {x:12,y:2}, {x:19,y:2}, {x:19,y:0}
                ]
            }
        ];

        // --- KONFIGURASI GLOBAL ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // State Global
        let currentMapGrid = [];
        let currentWaypoints = [];
        let activeScreen = 'home'; // home, mapSelect, game

        let money = 120;
        let lives = 20;
        let wave = 1;
        let gameActive = false; // Is playing map?
        let gameOver = false;
        
        let enemies = [];
        let towers = [];
        let projectiles = [];
        let particles = [];

        let selectedTowerType = null;
        let enemiesToSpawn = 0;
        let waveInProgress = false;

        const TOWER_TYPES = {
            archer: { name: 'Pemanah', cost: 50, range: 120, damage: 20, cooldown: 40, color: '#3B82F6', type: 'single' },
            cannon: { name: 'Meriam', cost: 120, range: 100, damage: 60, cooldown: 90, color: '#DC2626', type: 'splash' },
            sniper: { name: 'Sniper', cost: 200, range: 300, damage: 100, cooldown: 150, color: '#9333EA', type: 'single' }
        };

        // --- CLASSES ---
        class Enemy {
            constructor(hp, speed, reward) {
                // Posisi awal di waypoint pertama
                let startWp = currentWaypoints[0];
                this.x = startWp.x;
                this.y = startWp.y;
                this.wpIndex = 0;
                this.hp = hp;
                this.maxHp = hp;
                this.speed = speed;
                this.reward = reward;
                this.radius = 12;
            }

            update() {
                if (this.wpIndex < currentWaypoints.length - 1) {
                    let target = currentWaypoints[this.wpIndex + 1];
                    let dx = target.x - this.x;
                    let dy = target.y - this.y;
                    let dist = Math.sqrt(dx*dx + dy*dy);

                    if (dist < this.speed) {
                        this.x = target.x;
                        this.y = target.y;
                        this.wpIndex++;
                    } else {
                        this.x += (dx / dist) * this.speed;
                        this.y += (dy / dist) * this.speed;
                    }
                } else {
                    lives--;
                    updateUI();
                    return true;
                }
                return false;
            }

            draw() {
                ctx.beginPath();
                ctx.fillStyle = `hsl(${(this.hp/this.maxHp)*120}, 100%, 50%)`;
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fill();
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 2;
                ctx.stroke();
            }
        }

        class Tower {
            constructor(c, r, typeKey) {
                this.c = c; 
                this.r = r;
                this.x = c * TILE_SIZE + TILE_SIZE/2;
                this.y = r * TILE_SIZE + TILE_SIZE/2;
                this.type = typeKey;
                this.stats = TOWER_TYPES[typeKey];
                this.cooldownTimer = 0;
                this.angle = 0;
            }

            update() {
                if (this.cooldownTimer > 0) this.cooldownTimer--;

                let target = null;
                let minDist = Infinity;

                for (let enemy of enemies) {
                    let dist = Math.hypot(enemy.x - this.x, enemy.y - this.y);
                    if (dist <= this.stats.range) {
                        if (!target || enemy.wpIndex > target.wpIndex || (enemy.wpIndex === target.wpIndex && dist < minDist)) {
                            target = enemy;
                            minDist = dist;
                        }
                    }
                }

                if (target) {
                    this.angle = Math.atan2(target.y - this.y, target.x - this.x);
                    if (this.cooldownTimer <= 0) {
                        this.shoot(target);
                        this.cooldownTimer = this.stats.cooldown;
                    }
                }
            }

            shoot(target) {
                if (this.stats.type === 'single') {
                    projectiles.push(new Projectile(this.x, this.y, target, this.stats.damage, this.type));
                } else if (this.stats.type === 'splash') {
                    projectiles.push(new Projectile(this.x, this.y, target, this.stats.damage, this.type, true));
                }
            }

            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.fillStyle = '#374151';
                ctx.fillRect(-16, -16, 32, 32);
                ctx.rotate(this.angle);
                ctx.fillStyle = this.stats.color;
                
                if(this.type === 'archer') {
                    ctx.beginPath();
                    ctx.arc(0, 0, 12, 0, Math.PI*2);
                    ctx.fill();
                    ctx.fillStyle = '#fff';
                    ctx.fillRect(0, -2, 20, 4);
                } else if (this.type === 'cannon') {
                    ctx.fillRect(-10, -10, 20, 20);
                    ctx.fillStyle = '#000';
                    ctx.fillRect(0, -8, 24, 16);
                } else if (this.type === 'sniper') {
                    ctx.beginPath();
                    ctx.moveTo(10, 0);
                    ctx.lineTo(-10, 10);
                    ctx.lineTo(-10, -10);
                    ctx.fill();
                    ctx.fillStyle = '#ccc';
                    ctx.fillRect(0, -2, 28, 4);
                }
                ctx.restore();
            }
        }

        class Projectile {
            constructor(x, y, target, damage, towerType, isSplash = false) {
                this.x = x;
                this.y = y;
                this.target = target;
                this.damage = damage;
                this.speed = towerType === 'sniper' ? 20 : (towerType === 'cannon' ? 5 : 8);
                this.isSplash = isSplash;
                this.active = true;
                this.targetX = target.x;
                this.targetY = target.y;
            }

            update() {
                if (this.target && enemies.includes(this.target)) {
                    this.targetX = this.target.x;
                    this.targetY = this.target.y;
                }

                let dx = this.targetX - this.x;
                let dy = this.targetY - this.y;
                let dist = Math.sqrt(dx*dx + dy*dy);

                if (dist < this.speed) {
                    this.hit();
                    return true;
                } else {
                    this.x += (dx/dist) * this.speed;
                    this.y += (dy/dist) * this.speed;
                }
                return false;
            }

            hit() {
                if (this.isSplash) {
                    createParticles(this.x, this.y, '#F87171');
                    enemies.forEach(e => {
                        if (Math.hypot(e.x - this.x, e.y - this.y) < 60) {
                            e.hp -= this.damage;
                        }
                    });
                } else {
                    createParticles(this.x, this.y, '#FFF');
                    if (this.target && enemies.includes(this.target)) {
                        this.target.hp -= this.damage;
                    }
                }
                this.active = false;
            }

            draw() {
                ctx.beginPath();
                ctx.fillStyle = this.isSplash ? '#000' : '#FFD700';
                ctx.arc(this.x, this.y, this.isSplash ? 5 : 3, 0, Math.PI*2);
                ctx.fill();
            }
        }

        class Particle {
            constructor(x, y, color) {
                this.x = x;
                this.y = y;
                this.color = color;
                this.size = Math.random() * 3 + 1;
                this.speedX = Math.random() * 4 - 2;
                this.speedY = Math.random() * 4 - 2;
                this.life = 20;
            }
            update() {
                this.x += this.speedX;
                this.y += this.speedY;
                this.life--;
            }
            draw() {
                ctx.globalAlpha = this.life / 20;
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x, this.y, this.size, this.size);
                ctx.globalAlpha = 1.0;
            }
        }

        function createParticles(x, y, color) {
            for(let i=0; i<5; i++) {
                particles.push(new Particle(x, y, color));
            }
        }

        // --- SISTEM GAME LOOP & LOGIKA ---

        function startWave() {
            if (waveInProgress) return;
            waveInProgress = true;
            document.getElementById('startWaveBtn').innerText = "GELOMBANG BERJALAN...";
            document.getElementById('startWaveBtn').disabled = true;
            document.getElementById('startWaveBtn').classList.add('opacity-50', 'cursor-not-allowed');

            let count = 5 + Math.floor(wave * 1.5);
            let hp = 40 + (wave * 25);
            let speed = 2 + (wave * 0.1);
            let reward = 10 + Math.floor(wave/2);

            enemiesToSpawn = count;
            
            const spawner = setInterval(() => {
                if (gameOver || !gameActive) { clearInterval(spawner); return; }
                if (enemiesToSpawn > 0) {
                    enemies.push(new Enemy(hp, speed, reward));
                    enemiesToSpawn--;
                } else {
                    clearInterval(spawner);
                }
            }, 800);
        }

        function gameLoop() {
            if (!gameActive) {
                requestAnimationFrame(gameLoop);
                return;
            }
            
            if (gameOver) return;

            // Logic Update
            for (let i = enemies.length - 1; i >= 0; i--) {
                let e = enemies[i];
                if (e.update()) {
                    enemies.splice(i, 1);
                } else if (e.hp <= 0) {
                    money += e.reward;
                    createParticles(e.x, e.y, '#4ADE80');
                    enemies.splice(i, 1);
                    updateUI();
                }
            }

            if (waveInProgress && enemiesToSpawn === 0 && enemies.length === 0) {
                waveInProgress = false;
                wave++;
                updateUI();
                document.getElementById('startWaveBtn').innerText = "MULAI GELOMBANG " + wave;
                document.getElementById('startWaveBtn').disabled = false;
                document.getElementById('startWaveBtn').classList.remove('opacity-50', 'cursor-not-allowed');
            }

            towers.forEach(t => t.update());

            for (let i = projectiles.length - 1; i >= 0; i--) {
                if (projectiles[i].update()) {
                    projectiles.splice(i, 1);
                }
            }

            for (let i = particles.length - 1; i >= 0; i--) {
                particles[i].update();
                if (particles[i].life <= 0) particles.splice(i, 1);
            }

            if (lives <= 0) {
                gameOver = true;
                document.getElementById('gameOverScreen').classList.remove('hidden');
            }

            // Drawing
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw Map
            for (let r = 0; r < currentMapGrid.length; r++) {
                for (let c = 0; c < currentMapGrid[0].length; c++) {
                    let x = c * TILE_SIZE;
                    let y = r * TILE_SIZE;
                    if (currentMapGrid[r][c] === 1) {
                        ctx.fillStyle = '#D1D5DB';
                        ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE);
                    } else {
                        ctx.fillStyle = ((c+r)%2 === 0) ? '#10B981' : '#059669';
                        ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE);
                    }
                }
            }

            // Draw Indicators
            let mx = Math.floor(mouseX / TILE_SIZE) * TILE_SIZE;
            let my = Math.floor(mouseY / TILE_SIZE) * TILE_SIZE;
            
            if (selectedTowerType && mx >= 0 && mx < canvas.width && my >= 0 && my < canvas.height) {
                let col = Math.floor(mouseX / TILE_SIZE);
                let row = Math.floor(mouseY / TILE_SIZE);
                
                let valid = true;
                if (!currentMapGrid[row] || currentMapGrid[row][col] === 1) valid = false;
                towers.forEach(t => { if (t.c === col && t.r === row) valid = false; });

                ctx.strokeStyle = valid ? 'white' : 'red';
                ctx.lineWidth = 2;
                ctx.strokeRect(mx, my, TILE_SIZE, TILE_SIZE);
                
                ctx.beginPath();
                ctx.arc(mx + TILE_SIZE/2, my + TILE_SIZE/2, TOWER_TYPES[selectedTowerType].range, 0, Math.PI*2);
                ctx.fillStyle = valid ? 'rgba(255, 255, 255, 0.2)' : 'rgba(255, 0, 0, 0.2)';
                ctx.fill();
            }

            enemies.forEach(e => e.draw());
            towers.forEach(t => t.draw());
            projectiles.forEach(p => p.draw());
            particles.forEach(p => p.draw());

            requestAnimationFrame(gameLoop);
        }

        // --- SISTEM MENU & NAVIGASI ---

        function showHome() {
            activeScreen = 'home';
            gameActive = false;
            document.getElementById('homeScreen').classList.remove('hidden');
            document.getElementById('mapSelectScreen').classList.add('hidden');
            document.getElementById('gameUI').classList.add('hidden');
        }

        function showMapSelection() {
            activeScreen = 'mapSelect';
            document.getElementById('homeScreen').classList.add('hidden');
            document.getElementById('mapSelectScreen').classList.remove('hidden');
        }

        let currentMapIndex = 0;

        function loadMap(mapIndex) {
            currentMapIndex = mapIndex;
            const map = MAP_DATA[mapIndex];
            
            // Setup Data
            currentMapGrid = JSON.parse(JSON.stringify(map.grid)); // Deep copy grid
            // Konversi waypoint grid ke pixel
            currentWaypoints = map.waypoints.map(p => ({
                x: p.x * TILE_SIZE + TILE_SIZE/2,
                y: p.y * TILE_SIZE + TILE_SIZE/2
            }));

            // Reset Game State
            money = 120;
            lives = 20;
            wave = 1;
            enemies = [];
            towers = [];
            projectiles = [];
            particles = [];
            gameOver = false;
            waveInProgress = false;
            enemiesToSpawn = 0;
            selectedTowerType = null;
            updateButtonStyles();

            // UI Changes
            activeScreen = 'game';
            gameActive = true;
            document.getElementById('mapSelectScreen').classList.add('hidden');
            document.getElementById('gameUI').classList.remove('hidden');
            document.getElementById('gameOverScreen').classList.add('hidden');
            document.getElementById('startWaveBtn').innerText = "MULAI GELOMBANG 1";
            document.getElementById('startWaveBtn').disabled = false;
            document.getElementById('startWaveBtn').classList.remove('opacity-50', 'cursor-not-allowed');
            
            updateUI();
        }

        function quitGame() {
            gameActive = false;
            showHome();
        }

        function restartLevel() {
            loadMap(currentMapIndex);
        }

        // --- INPUT & EVENT LISTENERS ---

        let mouseX = 0;
        let mouseY = 0;

        function getMousePos(evt) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            return {
                x: (evt.clientX - rect.left) * scaleX,
                y: (evt.clientY - rect.top) * scaleY
            };
        }

        canvas.addEventListener('mousemove', (e) => {
            if (!gameActive) return;
            const pos = getMousePos(e);
            mouseX = pos.x;
            mouseY = pos.y;
        });

        canvas.addEventListener('mousedown', (e) => {
            if (!gameActive || gameOver) return;
            const pos = getMousePos(e);
            const col = Math.floor(pos.x / TILE_SIZE);
            const row = Math.floor(pos.y / TILE_SIZE);

            if (selectedTowerType) {
                if (currentMapGrid[row] && currentMapGrid[row][col] === 0) { // Bukan jalan
                    let occupied = towers.some(t => t.c === col && t.r === row);
                    if (!occupied) {
                        let cost = TOWER_TYPES[selectedTowerType].cost;
                        if (money >= cost) {
                            money -= cost;
                            towers.push(new Tower(col, row, selectedTowerType));
                            createParticles(col*TILE_SIZE + 20, row*TILE_SIZE+20, '#fff');
                            updateUI();
                        } else {
                            // alert("Uang tidak cukup!"); // Optional
                        }
                    }
                }
            }
        });

        function selectTower(type) {
            selectedTowerType = type;
            updateButtonStyles();
        }

        function updateButtonStyles() {
            document.querySelectorAll('.tower-btn').forEach(btn => {
                btn.classList.remove('border-yellow-400', 'bg-gray-600');
                btn.classList.add('border-gray-600', 'bg-gray-700');
            });
            if (selectedTowerType) {
                const btn = document.getElementById('btn-' + selectedTowerType);
                btn.classList.remove('border-gray-600', 'bg-gray-700');
                btn.classList.add('border-yellow-400', 'bg-gray-600');
            }
        }

        function updateUI() {
            document.getElementById('moneyDisplay').innerText = `Rp ${money}`;
            document.getElementById('livesDisplay').innerText = lives;
            document.getElementById('waveDisplay').innerText = wave;
        }

        document.getElementById('startWaveBtn').addEventListener('click', startWave);

        // Mulai Loop Animasi (selalu berjalan, tapi logika di dalamnya di-pause jika game tidak aktif)
        requestAnimationFrame(gameLoop);
        
        // Init awal
        showHome();

    </script>
</body>
</html>